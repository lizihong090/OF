#include <ESP8266WiFi.h>
#include <ESP8266HTTPClient.h>
#include <ArduinoJson.h>

// ===== WiFi 設定 =====
const char* ssid     = "dlink-21b";
const char* password = "0980253945";

// ===== Firebase Realtime Database =====
const char* firebaseURL = "https://of11-bf42c-default-rtdb.firebaseio.com/status.json?auth=BIyPl1KhSGcPBL5rrIjrNFtYZCAUzFe9icAYrEFeBg8GER5cBPMxHzx43S-Xo4szVkMefZE6pe7lHI95UpdX-7c";

// ===== GPIO 設定 =====
const uint8_t D4_PIN = 2;   // NodeMCU D4
const uint8_t D5_PIN = 14;  // NodeMCU D5
const uint8_t PWM_PIN = 5;  // NodeMCU D1 (PWM)

// ===== 狀態追蹤 =====
int lastD4 = -1;
int lastPwm = -1;

WiFiClientSecure client;
HTTPClient http;

// ===== D5 脈衝函式 =====
void pulseD5() {
  digitalWrite(D5_PIN, LOW);   // 低電位 0.5 秒
  delay(500);
  digitalWrite(D5_PIN, HIGH);  // 高電位 0.5 秒
  delay(500);
}

// ===== Firebase 只更新單一欄位函式 =====
void updateFirebaseField(const char* key, int value) {
  DynamicJsonDocument doc(128);
  doc[key] = value;
  String payload;
  serializeJson(doc, payload);

  http.begin(client, firebaseURL);
  http.addHeader("Content-Type", "application/json");
  http.PUT(payload);  // PATCH 模式，只更新 key
  http.end();
}

void setup() {
  Serial.begin(115200);
  delay(10);

  // 設定 GPIO
  pinMode(D4_PIN, OUTPUT);
  pinMode(D5_PIN, OUTPUT);
  pinMode(PWM_PIN, OUTPUT);

  digitalWrite(D4_PIN, LOW);   // D4 預設關
  digitalWrite(D5_PIN, HIGH);  // D5 預設高電位
  analogWriteRange(1023);
  analogWriteFreq(1000);
  analogWrite(PWM_PIN, 0);

  // 連線 WiFi
  Serial.printf("Connecting to WiFi %s ...\n", ssid);
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println();
  Serial.print("WiFi connected! IP: ");
  Serial.println(WiFi.localIP());

  client.setInsecure(); // HTTPS 測試用，不驗證憑證
}

void loop() {
  if (WiFi.status() == WL_CONNECTED) {
    http.begin(client, firebaseURL);
    int httpCode = http.GET();

    if (httpCode == 200) {
      String payload = http.getString();
      DynamicJsonDocument doc(512);
      DeserializationError error = deserializeJson(doc, payload);

      if (!error) {
        // 讀取 status 節點
        JsonObject status = doc.as<JsonObject>();

        int ledD4 = status["ledD4"] | 0;
        int ledD5 = status["ledD5"] | 0;
        int pwmVal = status["pwm"] | 0;

        // ===== D4 控制 =====
        if (ledD4 != lastD4) {
          digitalWrite(D4_PIN, ledD4 ? HIGH : LOW);
          lastD4 = ledD4;
          Serial.printf("D4: %s\n", ledD4 ? "ON" : "OFF");
        }

        // ===== D5 脈衝觸發 =====
        if (ledD5 == 1) {
          Serial.println("Trigger D5 pulse");
          pulseD5();
          // 脈衝完成後只回寫 ledD5 = 0，不影響其他欄位
          updateFirebaseField("ledD5", 0);
        }

        // ===== PWM 控制 =====
        if (pwmVal != lastPwm) {
          analogWrite(PWM_PIN, pwmVal);
          lastPwm = pwmVal;
          Serial.printf("PWM: %d\n", pwmVal);
        }

      } else {
        Serial.println("❌ JSON parse error");
      }
    } else {
      Serial.printf("❌ HTTP GET failed: %d\n", httpCode);
    }

    http.end();
  } else {
    Serial.println("⚠️ WiFi disconnected!");
  }

  delay(1000); // 每秒抓一次 Firebase
}

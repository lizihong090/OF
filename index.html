<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESP 控制面板</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  /* 這裡省略 CSS，與你原本 CSS 相同 */
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>ESP 控制面板</h1>
    <p class="subtitle">远程监控与控制设备</p>
  </header>

  <div class="dashboard">
    <!-- D4 控制 -->
    <div class="card">
      <div class="card-header">
        <div class="card-icon"><i class="fas fa-lightbulb"></i></div>
        <h2 class="card-title">D4 输出控制</h2>
      </div>
      <div class="control-group">
        <button id="d4Btn" class="btn btn-primary"><i class="fas fa-power-off"></i> 开启 D4</button>
      </div>
    </div>

    <!-- D5 脈衝 -->
    <div class="card">
      <div class="card-header">
        <div class="card-icon"><i class="fas fa-bolt"></i></div>
        <h2 class="card-title">D5 脉冲控制</h2>
      </div>
      <div class="control-group">
        <button id="d5Btn" class="btn btn-primary"><i class="fas fa-play"></i> 发送脉冲</button>
      </div>
    </div>

    <!-- PWM 控制 -->
    <div class="card">
      <div class="card-header">
        <div class="card-icon"><i class="fas fa-sliders-h"></i></div>
        <h2 class="card-title">PWM 调节器</h2>
      </div>
      <div class="control-group">
        <div class="slider-value"><span id="pwmVal">0</span></div>
        <div class="slider-container">
          <input type="range" id="pwmSlider" class="slider" min="0" max="1023" value="0">
        </div>
      </div>
    </div>

    <!-- DHT22 溫濕度 -->
    <div class="card">
      <div class="card-header">
        <div class="card-icon"><i class="fas fa-thermometer-half"></i></div>
        <h2 class="card-title">溫濕度 (DHT22)</h2>
      </div>
      <div class="control-group">
        <div class="slider-value">溫度: <span id="tempVal">--</span> ℃</div>
        <div class="slider-value">濕度: <span id="humVal">--</span> %</div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

// Firebase 設定
const firebaseConfig = {
  apiKey: "你的APIKey",
  authDomain: "of11-bf42c.firebaseapp.com",
  databaseURL: "https://of11-bf42c-default-rtdb.firebaseio.com",
  projectId: "of11-bf42c",
  storageBucket: "of11-bf42c.appspot.com",
  messagingSenderId: "你的ID",
  appId: "你的ID"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const statusRef = ref(db, 'status');

const d4Btn = document.getElementById("d4Btn");
const d5Btn = document.getElementById("d5Btn");
const pwmSlider = document.getElementById("pwmSlider");
const pwmVal = document.getElementById("pwmVal");
const tempVal = document.getElementById("tempVal");
const humVal = document.getElementById("humVal");

// 監聽 Firebase 更新
onValue(statusRef, (snapshot) => {
  const data = snapshot.val() || {};

  // D4
  d4Btn.innerHTML = data.ledD4 ? '<i class="fas fa-power-off"></i> 关闭 D4' : '<i class="fas fa-power-off"></i> 开启 D4';
  d4Btn.className = data.ledD4 ? 'btn btn-danger' : 'btn btn-primary';

  // PWM
  pwmSlider.value = data.pwm || 0;
  pwmVal.textContent = data.pwm || 0;

  // 溫濕度
  const sensor = data.sensor || {};
  tempVal.textContent = sensor.temp !== undefined ? sensor.temp : '--';
  humVal.textContent = sensor.hum !== undefined ? sensor.hum : '--';
});

// D4 開關
d4Btn.addEventListener("click", () => {
  onValue(statusRef, (snapshot) => {
    const data = snapshot.val() || {};
    const newD4 = data.ledD4 ? 0 : 1;
    update(statusRef, { ledD4: newD4 });
  }, { onlyOnce: true });
});

// D5 脈衝
d5Btn.addEventListener("click", () => {
  d5Btn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> 发送中...';
  d5Btn.disabled = true;
  update(statusRef, { ledD5: 1 });
  setTimeout(() => {
    d5Btn.innerHTML = '<i class="fas fa-play"></i> 发送脉冲';
    d5Btn.disabled = false;
  }, 2000);
});

// PWM
pwmSlider.addEventListener("input", () => {
  pwmVal.textContent = pwmSlider.value;
  update(statusRef, { pwm: parseInt(pwmSlider.value) });
});
</script>
</body>
</html>
